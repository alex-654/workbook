Процессоры запускаются в режиме ядра. Перед выполнением программы ядро инициализирует переключение в пользовательский
режим.
![](img/computer1.png)

Системный вызов — это специальная процедура, позволяющая программе запускать переход из пространства пользователя в
пространство ядра, перепрыгивать из кода программы в код ОС.

Передача управления из пространства пользователя в пространство ядра выполняется с помощью функций процессора, которые
называются программными прерываниями (software interrupts):

Вот, что мы узнали о системных вызовах:

- программы, запущенные в режиме пользователя, не имеют доступа к вводу/выводу или памяти. Им приходится обращаться к ОС
  за помощью во взаимодействии с внешним миром;
- программы могут передавать управление ОС с помощью специальных инструкций, содержащих машинный код, таких как INT и
  IRET;
- программы не могут переключать уровни привилегий напрямую. Программные прерывания являются безопасными, поскольку
  процессор предварительно настраивается ОС относительно того, к какому коду ОС следует обращаться. Векторная таблица
  прерываний может настраиваться только в режиме ядра.

ОС предоставляют слой абстракции поверх этих прерываний. "Переиспользуемые" высокоуровневые функции, оборачивающие
необходимые инструкции на языке ассемблера, предоставляются libc в Unix-подобных системах.
Простой вызов этих функций не влечет переключения в режим ядра.

### 2. Нарезка времени

Мы выяснили, что конкурентность (concurrency) может имитироваться путем выполнения процессов по очереди. Если мы
циклически перебираем процессы и выполняем по несколько инструкций из каждого, все процессы будут отзывчивыми и ни один
из них не загрузит ЦП полностью.

Планировщики (schedulers) ОС используют чипы таймеров, такие как PIT, для запуска программных прерываний в целях
многозадачности:

- Перед началом выполнения кода программы, ОС устанавливает чип таймера для запуска прерывания по истечение
  определенного времени.
- ОС переключается в режим пользователя и переходит к следующей инструкции программы.
- Когда срабатывает таймер, ОС запускает программное прерывание для переключения в режим ядра, и переходит к коду ОС.
- ОС запоминает, где остановилось выполнение программы, загружает другую программу и повторяет процесс.

Это называется "вытесняющей многозадачностью" (preemptive multitasking); прерывание процесса называется "вытеснением"
или "выгрузкой" (preemptive).

Временные интервалы вычисляются путем деления целевой задержки на количество задач. Такой подход лучше фиксированных
интервалов, поскольку он устраняет ненужное переключение с меньшим количеством процессов.
Переключение между процессами является дорогим с точки зрения вычислений, поскольку требует сохранения всего состояния
текущей программы и восстановления другого состояния.

Каждый процесс на компьютере является результатом клонирования-выполнения (fork-execed) родительской программы, кроме
одного: процесса инициализации (init process)
COW (copy on write) COW позволяет обоим процессам читать из одних и тех же физических адресов до тех пор, пока они не
пытаются осуществить запись в память. Как только процесс пытается это сделать, данная страница копируется в ОП. Это
позволяет обоим процессам иметь изолированную память без клонирования всего пространства памяти. Это обуславливает
эффективность паттерна fork-exec.

Оказывается, что когда ЦП читает из или пишет в адрес памяти, речь идет не о локации в физической памяти (ОП). Это место
в пространстве виртуальной памяти (virtual memory space).

ЦП "общается" с чипом под названием блок управления памятью (memory management unit, MMU).
Подкачка пэйджинг памяти
Абстракция ОС для работы с ram.
Преимущества

- изоляция одни процессы не имеют доступа к памяти других процессов
- процессам не нужно беспокоиться об использовании памяти другими процессами
- Виртуальная память делится на две части для ядра и процессов юзера
- каждая страница должна определять флаги разрешений (permission flags). Один флаг определяет, доступна область памяти
  только для чтения или также для записи. Другой флаг сообщает ЦП, что только ядро имеет доступ к области.